<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bosco del Ricordo – Mappa</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Dati -->
  <script src="./alberi_bosco.js"></script>

  <style>
    html, body { height:100%; margin:0; padding:0; background:transparent; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { height:100vh; width:100vw; }

    /* ===== Search box ===== */
    .searchbox {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 2000;
      width: 340px;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    .searchbox .row { display:flex; align-items:center; gap:8px; padding: 10px; }
    .searchbox input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f3f4f6;
    }
    .hint { font-size: 12px; color:#6b7280; padding: 0 12px 10px; }
    .results {
      max-height: 280px;
      overflow:auto;
      border-top: 1px solid rgba(0,0,0,.08);
      display:none;
      background: rgba(255,255,255,.98);
    }
    .result-item { padding: 10px 12px; cursor:pointer; border-bottom: 1px solid rgba(0,0,0,.06); }
    .result-item:hover { background:#f9fafb; }
    .result-title { font-weight: 650; font-size: 13px; color:#111827; }
    .result-sub { font-size: 12px; color:#6b7280; margin-top:2px; }

    /* ===== Desktop popup (Leaflet) ===== */
    .leaflet-popup-content-wrapper { border-radius: 16px; }
    .leaflet-popup-content {
      width: clamp(320px, 40vw, 420px);
      max-width: 90vw;
      max-height: min(70vh, 560px);
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
      margin: 14px;
      font-family: Georgia, serif;
      line-height: 1.45;
    }
    .popup .specie { font-size: 16px; font-weight: 700; margin: 6px 0 8px; }
    .popup .dedica { font-style: italic; margin: 8px 0; color: #444; }
    .popup .donatore, .popup .anno { font-size: 13px; color: #666; }
    .popup .imgwrap{
      width: 100%;
      aspect-ratio: 16 / 9;
      overflow: hidden;
      border-radius: 12px;
      background: #eee;
      margin-bottom: 10px;
      border: 1px solid rgba(0,0,0,.06);
    }
    .popup .imgwrap img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .leaflet-marker-icon { transition: transform .15s ease; }
    .leaflet-marker-icon:hover { transform: scale(1.15); }

    /* Evidenzia il marker selezionato (desktop + mobile) */
    .marker-selected {
      filter:
        brightness(0.65) saturate(1.4) contrast(1.1)
        drop-shadow(0 0 6px rgba(0,0,0,.35));
      transform: scale(1.12);
      transform-origin: bottom center;
    }


    /* ===== Mobile modal (full-screen card) ===== */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 5000;
      display: none;
      background: rgba(0,0,0,.35);
      padding: 10px;
      box-sizing: border-box;
    }
    .modal.open { display: flex; align-items: flex-start; justify-content: center; }
    .modal-card{
      width: min(720px, 100%);
      max-height: 92vh;
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      border: 1px solid rgba(0,0,0,.08);
      display: flex;
      flex-direction: column;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.96);
    }
    .modal-back{
      border: none;
      background: #f3f4f6;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
    }
    .modal-close{
      border: none;
      background: transparent;
      font-size: 22px;
      line-height: 1;
      cursor:pointer;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .modal-body{
      padding: 14px;
      overflow-y: auto;
      overflow-x: hidden;
      font-family: Georgia, serif;
      line-height: 1.45;
    }

    /* Mobile tweaks: search in basso e non sovrapposta */
    @media (max-width: 600px){
      #map { height: 100vh; width: 100vw; }
      .searchbox{
        top: auto;
        bottom: 12px;
        left: 12px;
        right: 12px;
        width: auto;
        max-width: calc(100vw - 24px);
      }
      .hint{ display:none; }
      .results{ max-height: 240px; }
      .leaflet-control-layers{
        margin-top: 8px;
      }
    }
  
    /* Mobile: scheda a metà schermo (sopra) e mappa visibile sotto */
    @media (max-width: 600px){
      .modal{
        background: transparent;      /* niente oscuramento */
        padding: 0;
        align-items: flex-start;
        justify-content: stretch;
      }
      .modal-card{
        width: 100%;
        max-height: none;
        height: 50vh;                /* metà schermo */
        border-radius: 0 0 18px 18px;
      }
    }

  </style>
</head>
<body>

  <!-- Search -->
  <div class="searchbox" id="searchbox">
    <div class="row">
      <input id="searchInput" type="text" placeholder="Cerca persona, donatore, specie, ID…" autocomplete="off" />
    </div>
    <div class="hint">Suggerimento: premi Invio per andare al primo risultato.</div>
    <div class="results" id="results"></div>
  </div>

  <div id="map"></div>

  <!-- Mobile modal -->
  <div class="modal" id="modal">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Scheda elemento">
      <div class="modal-head">
        <button class="modal-back" id="modalBack">← Torna alla mappa</button>
        <button class="modal-close" id="modalClose" aria-label="Chiudi">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const map = L.map('map', { zoomControl: true });

    const voyager = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
      { maxZoom: 22, attribution: '&copy; OpenStreetMap &copy; CARTO' }
    ).addTo(map);

    const sat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 22, attribution: 'Tiles &copy; Esri' }
    );

    L.control.layers({ "Strade": voyager, "Satellite": sat }, null, { collapsed: true }).addTo(map);

    // Quando chiudi un popup su desktop, togli l'evidenziazione
    map.on("popupclose", () => { clearSelectedMarker(); });

    const isMobile = window.matchMedia && window.matchMedia("(max-width: 600px)").matches;

    // Marker selezionato: evidenzia il punto cliccato
    let selectedMarker = null;

    function setSelectedMarker(marker) {
      try {
        if (selectedMarker && selectedMarker._icon) {
          selectedMarker._icon.classList.remove("marker-selected");
        }
        selectedMarker = marker;
        if (selectedMarker && selectedMarker._icon) {
          selectedMarker._icon.classList.add("marker-selected");
        }
      } catch (e) { /* noop */ }
    }

    function clearSelectedMarker() {
      try {
        if (selectedMarker && selectedMarker._icon) {
          selectedMarker._icon.classList.remove("marker-selected");
        }
      } catch (e) { /* noop */ }
      selectedMarker = null;
    }


    // Foto fiori per specie (cartella: ./img/)
    const specieImages = {
      'Prunus serrulata “Amanogawa”': './img/prunus_amanogawa.jpg',
      'Prunus serrulata “Kanzan”': './img/prunus_kanzan.jpg',
      'Prunus serrulata “Shiro-fugen”': './img/prunus_shirofugen.jpg',
      'Prunus serrulata “Tai-Haku”': './img/prunus_tai_haku.jpg',
      'Prunus × subhirtella “Autumnalis”': './img/prunus_subhirtella_autumnalis.jpg',
      'Prunus × subhirtella “Stellata”': './img/prunus_subhirtella_stellata.jpg',
      'Prunus × yedoensis': './img/prunus_yedoensis.jpg',
      'Prunus “Kursar”': './img/prunus_kursar.jpg',
      'Prunus “Accolade”': './img/prunus_accolade.jpg',
      'Prunus sargentii': './img/prunus_sargentii.jpg',

      'Malus "Golden Hornet"': './img/malus_golde_hornet.jpg',
      'Malus "Coccinella"': './img/malus_coccinella.jpg',
      'Malus "Red Sentinel"': './img/malus_red_sentinel.jpg',
      'Malus "Scarlet"': './img/malus_scarlet.jpg',
      'Malus "Evereste"': './img/malus_evereste.jpg',
      'Malus "John Downie"': './img/malus_john_downie.jpg',
      'Malus trilobata': './img/malus_trilobata.jpg',
      'Malus x purpurea': './img/malus_floribunda.jpg'
    };

    function getImageForFeature(p) {
      if (!p) return "";
      if (p.Img) return String(p.Img);
      const sp = p.Specie ?? "";
      return specieImages[sp] ?? "";
    }

    // Icone per Tipo
    const iconCache = new Map();
    function getIconByTipo(tipo) {
      const key = String(tipo ?? "1");
      if (iconCache.has(key)) return iconCache.get(key);
      const icon = L.icon({
        iconUrl: `./icons/${key}.png`,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -28]
      });
      iconCache.set(key, icon);
      return icon;
    }

    // Costruisce HTML scheda (popup/modal)
    function buildCardHTML(p){
      const dedicaRaw = (p.Dedica ?? "").toString();
      const memoria = (p["In memoria di"] ?? "").toString().trim();
  const memoriaHtml = memoria ? `<div><b>In memoria di:</b> ${memoria}</div>` : "";

  const dedica = dedicaRaw
        .replace(/\r\n|\n|\r/g, "<br>")
        .replace(/\\n/g, "<br>");

      const imgUrl = getImageForFeature(p);
      const imgHtml = imgUrl
        ? `<div class="imgwrap"><img src="${imgUrl}" alt="${(p.Specie ?? "Foto").toString().replace(/"/g,"&quot;")}"></div>`
        : "";

      return `
        <div class="popup">
          ${imgHtml}
          <div class="specie">${p.Specie ?? ""}</div>
          ${memoriaHtml}
          ${dedica ? `<div class="dedica">${dedica}</div>` : ""}
          <div class="donatore"><b>Donatore:</b> ${p.Donatore ?? ""}</div>
          <div class="anno">Anno ${p.Anno ?? ""} • ID ${p.ID ?? ""}</div>
        </div>
      `;
    }

    // Mobile modal controls
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modalBody");
    const modalBack = document.getElementById("modalBack");
    const modalClose = document.getElementById("modalClose");
    const searchbox = document.getElementById("searchbox");

    function openModal(html, marker){
      modalBody.innerHTML = html;
      modal.classList.add("open");
      // su mobile nascondo la searchbox per non sovrapporla
      if (isMobile) searchbox.style.display = "none";

      // su mobile: centra il punto nella metà inferiore della mappa
      if (isMobile && marker && marker.getLatLng) {
        const ll = marker.getLatLng();
        const z = Math.max(map.getZoom(), 20);
        map.setView(ll, z, { animate: true });
        const offsetY = Math.round(map.getSize().y * 0.33);
        requestAnimationFrame(() => {
          map.panBy([0, -offsetY], { animate: true });
        });
      }
    }

    function closeModal(){
      modal.classList.remove("open");
      modalBody.innerHTML = "";
      if (isMobile) searchbox.style.display = "";
      clearSelectedMarker();
    }
    modalBack.addEventListener("click", closeModal);
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    const searchable = [];
    let centerMarker = null;

    const layer = L.geoJSON(alberiData, {
      pointToLayer: (feature, latlng) => {
        const p = feature.properties || {};
        const m = L.marker(latlng, { icon: getIconByTipo(p.Tipo) });
        if (String(p.ID) === "15") centerMarker = m;
        return m;
      },
      onEachFeature: (feature, lyr) => {
        const p = feature.properties || {};
        const html = buildCardHTML(p);

        if (!isMobile) {
          lyr.bindPopup(html, { maxWidth: 420 });
        }

        lyr.on("click", () => {
          setSelectedMarker(lyr);
          if (isMobile) openModal(html, lyr);
        });

        const searchText = [p.ID ?? "", p.Specie ?? "", p["In memoria di"] ?? "", p.Donatore ?? ""].join(" ").toLowerCase();
        searchable.push({ marker: lyr, id: p.ID ?? "", specie: p.Specie ?? "", memoria: p["In memoria di"] ?? "", donatore: p.Donatore ?? "", searchText });
      }
    }).addTo(map);

    if (centerMarker) {
      map.setView(centerMarker.getLatLng(), 20);
    } else {
      map.fitBounds(layer.getBounds(), { padding: [40, 40], maxZoom: 20 });
    }

    // Ricerca
    const input = document.getElementById("searchInput");
    const resultsEl = document.getElementById("results");

    function renderResults(items) {
      resultsEl.innerHTML = "";
      if (!items.length) { resultsEl.style.display = "none"; return; }
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
          <div class="result-title">ID ${item.id} • ${item.memoria ? item.memoria : (item.donatore || "—")}</div>
          <div class="result-sub">${item.specie || ""}${item.donatore ? " • " + item.donatore : ""}</div>`;
        div.onclick = () => {
          const ll = item.marker.getLatLng();
          map.setView(ll, 21);

          setSelectedMarker(item.marker);
          if (isMobile) {
            const p = item.marker.feature?.properties || {};
            openModal(buildCardHTML(p), item.marker);
          } else {
            item.marker.openPopup();
          }
          resultsEl.style.display = "none";
        };
        resultsEl.appendChild(div);
      });
      resultsEl.style.display = "block";
    }

    function doSearch(q) {
      q = (q || "").trim().toLowerCase();
      if (!q) { renderResults([]); return; }
      renderResults(searchable.filter(x => x.searchText.includes(q)).slice(0, 12));
    }

    input.addEventListener("input", e => doSearch(e.target.value));
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const hits = searchable.filter(x => x.searchText.includes(input.value.toLowerCase()));
        if (hits.length) {
          const ll = hits[0].marker.getLatLng();
          map.setView(ll, 21);
          setSelectedMarker(hits[0].marker);
          if (isMobile) {
            const p = hits[0].marker.feature?.properties || {};
            openModal(buildCardHTML(p), item.marker);
          } else {
            hits[0].marker.openPopup();
          }
          resultsEl.style.display = "none";
        }
      }
      if (e.key === "Escape") {
        input.value = "";
        renderResults([]);
      }
    });

    map.on("click", () => { resultsEl.style.display = "none"; clearSelectedMarker(); });
  </script>
</body>
</html>
